<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</title>
    <link rel="stylesheet" href="AdminPanel.css">
</head>
<body>
<!-- –ß–µ—Ä–¥–∞–∫ -->
    <div class="header-box">
        <div class="header-container">
            <a class="logo-container" href="Main.html" style="text-decoration: none; color: inherit;">
                <img src="media/logo.png" class="logo">
                <h1 class="title">–ö–æ—Ä–æ—á–∫–∏.–µ—Å—Ç—å</h1>
                <h3 class="undertitle">–¢–æ–ª—å–∫–æ "–ù–µ" –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω–æ–µ –æ–±—Ä–æ–∑–æ–≤–∞–Ω–∏–µ.</h3>
            </a>
            <div class="buttons">
                <a href="ApplicationReviewPage.html" class="btn1">–í–∞—à–∏ –∑–∞—è–≤–∫–∏</a>
                <a href="RequestFormationPage.html" class="btn2">–ü–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É</a>
            </div>
        </div>
    </div>

<!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
    <div class="main-container">
           <div class="somthing-container">
        <h2 class="t1">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å:</h2>
    </div>
    <div id="loginForm" class="login-form">
            <h2>–í—Ö–æ–¥ –≤ –ø–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h2>
            <input type="text" id="username" placeholder="–õ–æ–≥–∏–Ω" required>
            <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å" required>
            <button onclick="login()">–í–æ–π—Ç–∏</button>
            <div id="loginError" style="color: red; text-align: center; margin-top: 10px;"></div>
        </div>

        <!-- –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ -->
        <div id="adminPanel" class="hidden">
            <div class="admin-header">
                <h2 class="t1">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h2>
                <button class="logout-btn" onclick="logout()">–í—ã–π—Ç–∏</button>
            </div>
            
            <div class="somthing-container">
                <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞—è–≤–∫–∞–º–∏</h3>
            </div>
            
            <table class="applications-table">
                <thead>
                    <tr>
                        <th>–§–ò–û</th>
                        <th>Email</th>
                        <th>–ü—Ä–æ–≥—Ä–∞–º–º–∞</th>
                        <th>–î–∞—Ç–∞ –ø–æ–¥–∞—á–∏</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody id="applicationsTableBody">
                    <!-- –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
<!-- –ü–æ–¥–≤–∞–ª -->
    <div class="footer-box">
        <div class="footer-container">
            <a class="logo-container" href="Main.html" style="text-decoration: none; color: inherit;">
                <img src="media/logo.png" class="logo">
                <h1 class="title">–ö–æ—Ä–æ—á–∫–∏.–µ—Å—Ç—å</h1>
                <h3 class="undertitle">–¢–æ–ª—å–∫–æ "–ù–µ" –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω–æ–µ –æ–±—Ä–æ–∑–æ–≤–∞–Ω–∏–µ.</h3>
            </a>
            <div class="footer-columns">
                <div class="footer-column">
                    <li>–°—Ç—Ä–∞–Ω–∏—Ü—ã</li>
                    <ul>
                        <li><a href="Main.html" style="text-decoration: none; color: inherit;">–ì–ª–∞–≤–Ω–∞—è</a></li>
                        <li><a href="ApplicationReviewPage.html" style="text-decoration: none; color: inherit;">–°—Ç—Ä–∞–Ω–∏—Ü–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∑–∞—è–≤–æ–∫</a></li>
                        <li><a href="RequestFormationPage.html" style="text-decoration: none; color: inherit;">–°—Ç—Ä–∞–Ω–∏—Ü–∞ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞—è–≤–∫–∏</a></li>
                        <li><a href="AdminPanel.html" style="text-decoration: none; color: inherit;">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <li>–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è</li>
                    <ul>
                        <li><a href="#" style="text-decoration: none; color: inherit;">–£—Å–ª–æ–≤–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</a></li>
                        <li><a href="#" style="text-decoration: none; color: inherit;">–£—Å–ª–æ–≤–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è</a></li>
                        <li><a href="#" style="text-decoration: none; color: inherit;">–ü–æ–ª–∏—Ç–∏–∫–∞ –∫—É–∫–∏</a></li>
                        <li><a href="#" style="text-decoration: none; color: inherit;">–ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏</a></li>
                        <li><a href="#" style="text-decoration: none; color: inherit;">–û –Ω–∞—Å</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</body>
</html>

<script>
    let currentAdmin = null;
    const API_BASE_URL = 'http://localhost:3006'; // –î–æ–±–∞–≤–ª–µ–Ω–∞ –±–∞–∑–æ–≤–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä

    // –§—É–Ω–∫—Ü–∏—è –≤—Ö–æ–¥–∞ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Ä–æ–ª–∏
    async function login() {
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        const errorDiv = document.getElementById('loginError');
        
        try {
            const response = await fetch(`${API_BASE_URL}/admin-auth`, { // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω URL
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    email: username,
                    password: password
                })
            });

            const result = await response.json();

            if (result.success) {
                currentAdmin = result.user;
                document.getElementById('loginForm').classList.add('hidden');
                document.getElementById('adminPanel').classList.remove('hidden');
                loadApplications();
            } else {
                errorDiv.textContent = result.message;
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', error);
            errorDiv.textContent = '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 3006.';
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –≤—ã—Ö–æ–¥–∞
    function logout() {
        currentAdmin = null;
        document.getElementById('loginForm').classList.remove('hidden');
        document.getElementById('adminPanel').classList.add('hidden');
        document.getElementById('username').value = '';
        document.getElementById('password').value = '';
        document.getElementById('loginError').textContent = '';
    }

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞—è–≤–æ–∫ —Å —Å–µ—Ä–≤–µ—Ä–∞
    async function loadApplications() {
        try {
            const response = await fetch(`${API_BASE_URL}/admin-applications`); // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω URL
            const result = await response.json();

            if (result.success) {
                displayApplications(result.applications);
            } else {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∑–∞—è–≤–æ–∫:', result.message);
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∑–∞—è–≤–æ–∫:', error);
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∑–∞—è–≤–æ–∫ —Å –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–æ–π –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º
    function displayApplications(applications) {
        const tableBody = document.getElementById('applicationsTableBody');
        tableBody.innerHTML = '';

        // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –∑–∞—è–≤–∫–∏ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º
        const groupedApplications = {
            'new': applications.filter(app => app.status === 'new'),
            'in_progress': applications.filter(app => app.status === 'in_progress'),
            'completed': applications.filter(app => app.status === 'completed')
        };

        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∑–∞—è–≤–∫–∏ –ø–æ –≥—Ä—É–ø–ø–∞–º
        Object.keys(groupedApplications).forEach(status => {
            const statusApplications = groupedApplications[status];
            
            if (statusApplications.length > 0) {
                // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –≥—Ä—É–ø–ø—ã
                const groupHeader = document.createElement('tr');
                groupHeader.className = 'status-group-header';
                groupHeader.innerHTML = `
                    <td colspan="6" class="group-header">
                        <strong>${getStatusDisplayName(status)}</strong>
                        <span class="group-count">(${statusApplications.length} –∑–∞—è–≤–æ–∫)</span>
                    </td>
                `;
                tableBody.appendChild(groupHeader);

                // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞—è–≤–∫–∏ —ç—Ç–æ–π –≥—Ä—É–ø–ø—ã
                statusApplications.forEach((app) => {
                    const row = document.createElement('tr');
                    row.className = `application-row status-${app.status}`;
                    
                    const statusClass = getStatusClass(app.status);
                    const statusDisplayName = getStatusDisplayName(app.status);
                    
                    row.innerHTML = `
                        <td>${app.user_name} ${app.user_surname}</td>
                        <td>${app.user_email}</td>
                        <td>${app.course_name}</td>
                        <td>${new Date(app.created_at).toLocaleDateString('ru-RU')}</td>
                        <td><span class="status-badge ${statusClass}">${statusDisplayName}</span></td>
                        <td class="actions-cell">
                            ${app.status === 'new' ? 
                                `<button class="action-btn start-btn" onclick="changeStatus(${app.application_id}, 'in_progress')">–ù–∞—á–∞—Ç—å –æ–±—É—á–µ–Ω–∏–µ</button>` : 
                                ''}
                            ${app.status === 'in_progress' ? 
                                `<button class="action-btn complete-btn" onclick="changeStatus(${app.application_id}, 'completed')">–ó–∞–≤–µ—Ä—à–∏—Ç—å –æ–±—É—á–µ–Ω–∏–µ</button>` : 
                                ''}
                            ${app.status === 'completed' ? 
                                `<span class="completed-text">–û–±—É—á–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ</span>` : 
                                ''}
                            ${app.status !== 'completed' ? 
                                `<button class="action-btn cancel-btn" onclick="changeStatus(${app.application_id}, 'new')">–í–µ—Ä–Ω—É—Ç—å –≤ –Ω–æ–≤—ã–µ</button>` : 
                                ''}
                        </td>
                    `;
                    
                    tableBody.appendChild(row);
                });
            }
        });

        // –ï—Å–ª–∏ –Ω–µ—Ç –∑–∞—è–≤–æ–∫
        if (applications.length === 0) {
            const emptyRow = document.createElement('tr');
            emptyRow.innerHTML = '<td colspan="6" style="text-align: center; padding: 20px;">–ù–µ—Ç –∑–∞—è–≤–æ–∫ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</td>';
            tableBody.appendChild(emptyRow);
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –∑–∞—è–≤–∫–∏
    async function changeStatus(applicationId, newStatus) {
        if (!currentAdmin) {
            alert('–û—à–∏–±–∫–∞: –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
            return;
        }

        try {
            const response = await fetch(`${API_BASE_URL}/admin-applications/${applicationId}/status`, { // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω URL
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    newStatus: newStatus,
                    adminId: currentAdmin.user_id
                })
            });

            const result = await response.json();

            if (result.success) {
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –∑–∞—è–≤–∫–∏
                loadApplications();
            } else {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞: ' + result.message);
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞:', error);
            alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
        }
    }

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
    function getStatusClass(status) {
        switch(status) {
            case 'new': return 'status-new';
            case 'in_progress': return 'status-in-progress';
            case 'completed': return 'status-completed';
            default: return '';
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º
    async function testConnection() {
        try {
            console.log('üîÑ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º...');
            const response = await fetch(`${API_BASE_URL}/admin-test`); // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω URL
            const result = await response.json();
            console.log('‚úÖ –¢–µ—Å—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è:', result);
            return true;
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è:', error);
            return false;
        }
    }

    function getStatusDisplayName(status) {
        switch(status) {
            case 'new': return '–ù–æ–≤–∞—è';
            case 'in_progress': return '–í –æ–±—É—á–µ–Ω–∏–∏';
            case 'completed': return '–ó–∞–≤–µ—Ä—à–µ–Ω–æ';
            default: return status;
        }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏...');
        
        // –¢–µ—Å—Ç–∏—Ä—É–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        testConnection().then(success => {
            if (!success) {
                document.getElementById('loginError').textContent = 
                    '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, –∑–∞–ø—É—â–µ–Ω –ª–∏ —Å–µ—Ä–≤–µ—Ä –Ω–∞ –ø–æ—Ä—Ç—É 3006.';
            }
        });

        document.getElementById('loginForm').classList.remove('hidden');
        document.getElementById('adminPanel').classList.add('hidden');
    });
</script>