<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Панель администратора</title>
    <link rel="stylesheet" href="AdminPanel.css">
</head>
<body>
<!-- Чердак -->
    <div class="header-box">
        <div class="header-container">
            <a class="logo-container" href="Main.html" style="text-decoration: none; color: inherit;">
                <img src="media/logo.png" class="logo">
                <h1 class="title">Корочки.есть</h1>
                <h3 class="undertitle">Только "Не" качественное государственное оброзование.</h3>
            </a>
            <div class="buttons">
                <a href="ApplicationReviewPage.html" class="btn1">Ваши заявки</a>
                <a href="RequestFormationPage.html" class="btn2">Подать заявку</a>
            </div>
        </div>
    </div>

<!-- Основной контент -->
    <div class="main-container">
           <div class="somthing-container">
        <h2 class="t1">Админ-панель:</h2>
    </div>
    <div id="loginForm" class="login-form">
            <h2>Вход в панель администратора</h2>
            <input type="text" id="username" placeholder="Логин" required>
            <input type="password" id="password" placeholder="Пароль" required>
            <button onclick="login()">Войти</button>
            <div id="loginError" style="color: red; text-align: center; margin-top: 10px;"></div>
        </div>

        <!-- Панель администратора -->
        <div id="adminPanel" class="hidden">
            <div class="admin-header">
                <h2 class="t1">Админ-панель</h2>
                <button class="logout-btn" onclick="logout()">Выйти</button>
            </div>
            
            <div class="somthing-container">
                <h3>Управление заявками</h3>
            </div>
            
            <table class="applications-table">
                <thead>
                    <tr>
                        <th>ФИО</th>
                        <th>Email</th>
                        <th>Программа</th>
                        <th>Дата подачи</th>
                        <th>Статус</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody id="applicationsTableBody">
                    <!-- Данные будут заполнены через JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
<!-- Подвал -->
    <div class="footer-box">
        <div class="footer-container">
            <a class="logo-container" href="Main.html" style="text-decoration: none; color: inherit;">
                <img src="media/logo.png" class="logo">
                <h1 class="title">Корочки.есть</h1>
                <h3 class="undertitle">Только "Не" качественное государственное оброзование.</h3>
            </a>
            <div class="footer-columns">
                <div class="footer-column">
                    <li>Страницы</li>
                    <ul>
                        <li><a href="Main.html" style="text-decoration: none; color: inherit;">Главная</a></li>
                        <li><a href="ApplicationReviewPage.html" style="text-decoration: none; color: inherit;">Страница просмотра заявок</a></li>
                        <li><a href="RequestFormationPage.html" style="text-decoration: none; color: inherit;">Страница формирования заявки</a></li>
                        <li><a href="AdminPanel.html" style="text-decoration: none; color: inherit;">Админ-панель</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <li>Документация</li>
                    <ul>
                        <li><a href="#" style="text-decoration: none; color: inherit;">Условия пользователя</a></li>
                        <li><a href="#" style="text-decoration: none; color: inherit;">Условия использования</a></li>
                        <li><a href="#" style="text-decoration: none; color: inherit;">Политика куки</a></li>
                        <li><a href="#" style="text-decoration: none; color: inherit;">Политика конфиденциальности</a></li>
                        <li><a href="#" style="text-decoration: none; color: inherit;">О нас</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</body>
</html>

<script>
    let currentAdmin = null;
    const API_BASE_URL = 'http://localhost:3006'; // Добавлена базовая ссылка на сервер

    // Функция входа с проверкой роли
    async function login() {
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        const errorDiv = document.getElementById('loginError');
        
        try {
            const response = await fetch(`${API_BASE_URL}/admin-auth`, { // Исправлен URL
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    email: username,
                    password: password
                })
            });

            const result = await response.json();

            if (result.success) {
                currentAdmin = result.user;
                document.getElementById('loginForm').classList.add('hidden');
                document.getElementById('adminPanel').classList.remove('hidden');
                loadApplications();
            } else {
                errorDiv.textContent = result.message;
            }
        } catch (error) {
            console.error('Ошибка при авторизации:', error);
            errorDiv.textContent = 'Ошибка соединения с сервером. Убедитесь, что сервер запущен на порту 3006.';
        }
    }

    // Функция выхода
    function logout() {
        currentAdmin = null;
        document.getElementById('loginForm').classList.remove('hidden');
        document.getElementById('adminPanel').classList.add('hidden');
        document.getElementById('username').value = '';
        document.getElementById('password').value = '';
        document.getElementById('loginError').textContent = '';
    }

    // Функция загрузки заявок с сервера
    async function loadApplications() {
        try {
            const response = await fetch(`${API_BASE_URL}/admin-applications`); // Исправлен URL
            const result = await response.json();

            if (result.success) {
                displayApplications(result.applications);
            } else {
                console.error('Ошибка при загрузке заявок:', result.message);
            }
        } catch (error) {
            console.error('Ошибка при загрузке заявок:', error);
        }
    }

    // Функция отображения заявок с группировкой по статусам
    function displayApplications(applications) {
        const tableBody = document.getElementById('applicationsTableBody');
        tableBody.innerHTML = '';

        // Группируем заявки по статусам
        const groupedApplications = {
            'new': applications.filter(app => app.status === 'new'),
            'in_progress': applications.filter(app => app.status === 'in_progress'),
            'completed': applications.filter(app => app.status === 'completed')
        };

        // Отображаем заявки по группам
        Object.keys(groupedApplications).forEach(status => {
            const statusApplications = groupedApplications[status];
            
            if (statusApplications.length > 0) {
                // Добавляем заголовок группы
                const groupHeader = document.createElement('tr');
                groupHeader.className = 'status-group-header';
                groupHeader.innerHTML = `
                    <td colspan="6" class="group-header">
                        <strong>${getStatusDisplayName(status)}</strong>
                        <span class="group-count">(${statusApplications.length} заявок)</span>
                    </td>
                `;
                tableBody.appendChild(groupHeader);

                // Добавляем заявки этой группы
                statusApplications.forEach((app) => {
                    const row = document.createElement('tr');
                    row.className = `application-row status-${app.status}`;
                    
                    const statusClass = getStatusClass(app.status);
                    const statusDisplayName = getStatusDisplayName(app.status);
                    
                    row.innerHTML = `
                        <td>${app.user_name} ${app.user_surname}</td>
                        <td>${app.user_email}</td>
                        <td>${app.course_name}</td>
                        <td>${new Date(app.created_at).toLocaleDateString('ru-RU')}</td>
                        <td><span class="status-badge ${statusClass}">${statusDisplayName}</span></td>
                        <td class="actions-cell">
                            ${app.status === 'new' ? 
                                `<button class="action-btn start-btn" onclick="changeStatus(${app.application_id}, 'in_progress')">Начать обучение</button>` : 
                                ''}
                            ${app.status === 'in_progress' ? 
                                `<button class="action-btn complete-btn" onclick="changeStatus(${app.application_id}, 'completed')">Завершить обучение</button>` : 
                                ''}
                            ${app.status === 'completed' ? 
                                `<span class="completed-text">Обучение завершено</span>` : 
                                ''}
                            ${app.status !== 'completed' ? 
                                `<button class="action-btn cancel-btn" onclick="changeStatus(${app.application_id}, 'new')">Вернуть в новые</button>` : 
                                ''}
                        </td>
                    `;
                    
                    tableBody.appendChild(row);
                });
            }
        });

        // Если нет заявок
        if (applications.length === 0) {
            const emptyRow = document.createElement('tr');
            emptyRow.innerHTML = '<td colspan="6" style="text-align: center; padding: 20px;">Нет заявок для отображения</td>';
            tableBody.appendChild(emptyRow);
        }
    }

    // Функция изменения статуса заявки
    async function changeStatus(applicationId, newStatus) {
        if (!currentAdmin) {
            alert('Ошибка: администратор не авторизован');
            return;
        }

        try {
            const response = await fetch(`${API_BASE_URL}/admin-applications/${applicationId}/status`, { // Исправлен URL
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    newStatus: newStatus,
                    adminId: currentAdmin.user_id
                })
            });

            const result = await response.json();

            if (result.success) {
                // Перезагружаем заявки
                loadApplications();
            } else {
                alert('Ошибка при изменении статуса: ' + result.message);
            }
        } catch (error) {
            console.error('Ошибка при изменении статуса:', error);
            alert('Ошибка соединения с сервером');
        }
    }

    // Вспомогательные функции
    function getStatusClass(status) {
        switch(status) {
            case 'new': return 'status-new';
            case 'in_progress': return 'status-in-progress';
            case 'completed': return 'status-completed';
            default: return '';
        }
    }

    // Функция для тестирования соединения с сервером
    async function testConnection() {
        try {
            console.log('🔄 Тестирование соединения с сервером...');
            const response = await fetch(`${API_BASE_URL}/admin-test`); // Исправлен URL
            const result = await response.json();
            console.log('✅ Тест соединения:', result);
            return true;
        } catch (error) {
            console.error('❌ Ошибка тестирования соединения:', error);
            return false;
        }
    }

    function getStatusDisplayName(status) {
        switch(status) {
            case 'new': return 'Новая';
            case 'in_progress': return 'В обучении';
            case 'completed': return 'Завершено';
            default: return status;
        }
    }

    // Инициализация при загрузке страницы
    document.addEventListener('DOMContentLoaded', function() {
        console.log('🚀 Инициализация админ-панели...');
        
        // Тестируем соединение при загрузке
        testConnection().then(success => {
            if (!success) {
                document.getElementById('loginError').textContent = 
                    'Ошибка соединения с сервером. Проверьте, запущен ли сервер на порту 3006.';
            }
        });

        document.getElementById('loginForm').classList.remove('hidden');
        document.getElementById('adminPanel').classList.add('hidden');
    });
</script>