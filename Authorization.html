<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="Authorization.css">
    <title>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</title>
</head>
<body>
    <div class="main-container">
        <div class="somthing-container">
            <h2 class="t1">–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h2>
        </div>
        <div class="register-form">
            <form id="loginForm">
                <div class="input-group">
                    <input 
                        placeholder="Email" 
                        type="email" 
                        class="input-field"
                        id="email"
                        required
                    />
                </div>

                <div class="input-group">
                    <input 
                        placeholder="–ü–∞—Ä–æ–ª—å" 
                        type="password" 
                        class="input-field"
                        id="password"
                        required
                        minlength="6"
                    />
                </div>

                <button type="submit" class="submit-btn" id="submitBtn">–í–æ–π—Ç–∏</button>
                
                <div class="login-section">
                    <span class="login-text">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? </span>
                    <a href="Registration.html" class="login-link">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è!</a>
                </div>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const loginForm = document.getElementById('loginForm');
            const emailInput = document.getElementById('email');
            const passwordInput = document.getElementById('password');
            const submitBtn = document.getElementById('submitBtn');

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ
            checkAuthStatus();

            function showNotification(message, isSuccess = false) {
                const existingNotification = document.querySelector('.notification');
                if (existingNotification) {
                    existingNotification.remove();
                }

                const notification = document.createElement('div');
                notification.className = `notification ${isSuccess ? 'success' : 'error'}`;
                notification.textContent = message;
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 15px 20px;
                    border-radius: 5px;
                    color: white;
                    font-weight: bold;
                    z-index: 1000;
                    max-width: 300px;
                    transition: all 0.3s ease;
                    background-color: ${isSuccess ? '#4CAF50' : '#f44336'};
                    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                `;

                document.body.appendChild(notification);

                setTimeout(() => {
                    notification.style.opacity = '0';
                    notification.style.transform = 'translateX(100px)';
                    setTimeout(() => notification.remove(), 300);
                }, 5000);
            }

            function isValidEmail(email) {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return emailRegex.test(email);
            }

            function setButtonState(isLoading) {
                if (isLoading) {
                    submitBtn.disabled = true;
                    submitBtn.textContent = '–í—Ö–æ–¥...';
                    submitBtn.style.opacity = '0.7';
                } else {
                    submitBtn.disabled = false;
                    submitBtn.textContent = '–í–æ–π—Ç–∏';
                    submitBtn.style.opacity = '1';
                }
            }

            function checkAuthStatus() {
                const isAuthenticated = localStorage.getItem('isAuthenticated');
                if (isAuthenticated === 'true') {
                    console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
                    // –ú–æ–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏—Ç—å
                    showNotification('–í—ã —É–∂–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã!', true);
                }
            }

            loginForm.addEventListener('submit', async function(e) {
                e.preventDefault();

                const email = emailInput.value.trim();
                const password = passwordInput.value.trim();

                if (!email) {
                    showNotification('–í–≤–µ–¥–∏—Ç–µ email');
                    emailInput.focus();
                    return;
                }

                if (!isValidEmail(email)) {
                    showNotification('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email');
                    emailInput.focus();
                    return;
                }

                if (!password) {
                    showNotification('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å');
                    passwordInput.focus();
                    return;
                }

                if (password.length < 6) {
                    showNotification('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤');
                    passwordInput.focus();
                    return;
                }

                setButtonState(true);

                try {
                    const response = await fetch('http://localhost:3006/auth', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            email: email,
                            password: password
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
    showNotification('–£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥!', true);
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const userData = result.user;
    localStorage.setItem('user', JSON.stringify(userData));
    localStorage.setItem('isAuthenticated', 'true');
    localStorage.setItem('userId', userData.user_id.toString());
    localStorage.setItem('userName', userData.name || '');
    localStorage.setItem('userEmail', userData.email || '');
    localStorage.setItem('userRole', userData.role || 'user');

    console.log('‚úÖ –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ localStorage:');
    console.log('user_id:', userData.user_id);
    console.log('name:', userData.name);
    console.log('email:', userData.email);

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–∏–ª–∏—Å—å
    setTimeout(() => {
        console.log('üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:');
        console.log('localStorage userId:', localStorage.getItem('userId'));
        console.log('localStorage isAuthenticated:', localStorage.getItem('isAuthenticated'));
    }, 100);

    // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
    setTimeout(() => {
        window.location.href = 'Main.html';
    }, 1000);

} else {
    showNotification(result.message);
}
                } catch (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', error);
                    showNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
                } finally {
                    setButtonState(false);
                }
            });

            emailInput.addEventListener('blur', function() {
                const email = this.value.trim();
                if (email && !isValidEmail(email)) {
                    this.style.borderColor = '#f44336';
                } else {
                    this.style.borderColor = '';
                }
            });

            passwordInput.addEventListener('input', function() {
                if (this.value.length > 0 && this.value.length < 6) {
                    this.style.borderColor = '#f44336';
                } else {
                    this.style.borderColor = '';
                }
            });
        });
    </script>
</body>
</html>